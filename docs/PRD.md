# 陪伴机器人插件 - 产品需求文档 (PRD)

> **版本**: v1.0
> **最后更新**: 2026-01-12
> **产品负责人**: -
> **开发状态**: 设计阶段

---

## 一、产品概述

### 1.1 产品定位
一个基于 AstrBot 的情感陪伴插件，通过**无条件肯定**和**成就重构**，为焦虑、自我攻击的用户提供情绪价值。

### 1.2 核心价值主张
- **目标用户**: 工作日/周末后感到焦虑、愧疚、自我攻击的人群
- **核心痛点**: 下班后或周末休息时，觉得"今天又荒废了"的焦虑感
- **解决方案**: 通过AI驱动的高情商回复，提供急需的情绪价值和成就感确认

### 1.3 产品形态
- **类型**: AstrBot 插件
- **交互方式**: 主动定时推送 + 被动指令触发
- **核心技术**: 定时任务 + LLM生成 + 会话控制

---

## 二、功能设计

### 2.1 核心功能模块

#### 功能 1: 定时主动问候 ⭐⭐⭐
**优先级**: P0 (MVP必需)

**功能描述**:
每天晚上 10:00 (可配置)，机器人主动推送温暖的问候消息。

**交互流程**:
```
[晚上10:00]
    ↓
[机器人]: "嘿，今天感觉怎么样？有没有做什么让你觉得还不错的事？哪怕很小的一件~"
```

**技术实现**:
- 使用 `asyncio.create_task()` 创建定时任务
- 计算每日触发时间，使用 `asyncio.sleep()` 等待
- 调用 `context.send_message()` 主动推送消息

**配置项**:
- `scheduled_time`: 推送时间 (默认 "22:00")
- `enable_scheduled_push`: 是否启用定时推送 (默认 true)
- `target_users`: 推送目标用户列表

---

#### 功能 2: 智能夸夸回复 ⭐⭐⭐
**优先级**: P0 (MVP必需)

**功能描述**:
基于 LLM 的高情商回复生成，无条件肯定用户的任何行为。

**回复特点**:
- ✅ 无条件肯定：不管做了什么都找到值得夸的点
- ✅ 价值重构：将"小事"重新定义为"进步"
- ✅ 数据化鼓励：使用具体数字/对比（"超过90%的人"）
- ✅ 行动许可：给予"可以休息了"的心理许可

**示例对话**:
```
用户: "就看了两页书"
机器人: "太强了！在工作了一整天之后还能坚持看两页书，这已经超过90%的人了。今天的进度条已经动了，安心去睡吧！"

用户: "今天啥也没干，摆烂了一天"
机器人: "能察觉到自己在休息，说明你的身体在向你发信号——你需要充电了。听从身体的声音也是一种智慧，今天的你很诚实！"
```

**核心 Prompt** (见附录 A)

**技术实现**:
- 使用 `context.llm_generate()` 调用 LLM
- 传入专属 Prompt 模板
- 将用户输入作为变量填充

**配置项**:
- `reply_style`: 回复风格 (激励型/平衡型/温柔型)

---

#### 功能 3: 多轮对话支持 ⭐⭐
**优先级**: P0 (MVP必需)

**功能描述**:
支持 3 轮内的深度对话，避免"一问一答"的机械感。

**交互流程**:
```
[机器人问候]
    ↓
[用户回复] (60秒超时)
    ↓
[机器人夸夸]
    ↓
[机器人追问]: "还有其他想分享的吗？"
    ↓
[用户回复"没了"] → 结束
```

**技术实现**:
- 使用 `session_waiter` 和 `SessionController`
- 设置 60 秒超时
- 超时后发送温柔提示："累了就早点休息吧~"

---

#### 功能 4: 手动触发指令 ⭐⭐
**优先级**: P1 (MVP后第一批)

**指令列表**:

| 指令 | 功能 | 示例 |
|-----|------|------|
| `/夸夸我` | 主动触发夸夸对话 | 用户想要获得肯定时使用 |
| `/今日总结` | 同 `/夸夸我` | 语义化别名 |

**技术实现**:
```python
@filter.command("夸夸我")
async def praise_me(self, event: AstrMessageEvent):
    yield event.plain_result("今天做了什么想和我分享的吗？")
    # 启动会话等待...
```

---

#### 功能 5: 打卡记录 ⭐
**优先级**: P2 (可选)

**功能描述**:
记录用户每天分享的"小成就"，生成周报/月报。

**数据结构**:
```python
{
  "user_id": {
    "2026-01-12": {
      "content": "看了两页书",
      "timestamp": "2026-01-12 22:15:30"
    },
    ...
  }
}
```

**周报生成**:
```
[每周日晚上]
机器人: "这周你已经坚持了5天打卡，太厉害了！回顾一下：
- 周一: 修了个bug
- 周二: 看了两页书
- 周三: 整理了桌面
..."
```

**技术实现**:
- 使用 `put_kv_data()` / `get_kv_data()` 存储
- 定时任务生成周报

---

### 2.2 配置项设计

创建 `_conf_schema.json`:

```json
{
  "scheduled_time": {
    "description": "每日问候时间",
    "type": "string",
    "default": "22:00",
    "hint": "格式: HH:MM (如 22:00)"
  },
  "reply_style": {
    "description": "回复风格",
    "type": "enum",
    "default": "balanced",
    "enum_values": ["enthusiastic", "balanced", "gentle"],
    "enum_labels": ["激励型(超燃)", "平衡型(推荐)", "温柔型(治愈)"]
  },
  "enable_scheduled_push": {
    "description": "启用定时推送",
    "type": "bool",
    "default": true
  },
  "target_users": {
    "description": "推送目标用户(留空推送所有)",
    "type": "string",
    "default": "",
    "hint": "多个用户用逗号分隔，如: qq:123456,qq:789012"
  },
  "max_conversation_rounds": {
    "description": "最大对话轮数",
    "type": "int",
    "default": 3,
    "hint": "避免过度打扰"
  }
}
```

---

## 三、技术架构

### 3.1 架构图

```
┌─────────────────────────────────────┐
│  定时任务模块                         │
│  (每天10:00触发)                     │
└──────────┬──────────────────────────┘
           │
           v
┌─────────────────────────────────────┐
│  消息推送                             │
│  主动发送问候语                       │
└──────────┬──────────────────────────┘
           │
           v
┌─────────────────────────────────────┐
│  会话控制模块                         │
│  (等待用户回复，超时60秒)             │
└──────────┬──────────────────────────┘
           │
           v
┌─────────────────────────────────────┐
│  AI回复生成                           │
│  (调用LLM + 专属Prompt)              │
└──────────┬──────────────────────────┘
           │
           v
┌─────────────────────────────────────┐
│  数据存储 (可选)                      │
│  (记录打卡、情绪标签)                 │
└─────────────────────────────────────┘
```

### 3.2 技术选型

| 功能模块 | 技术方案 | AstrBot API |
|---------|---------|-------------|
| 定时任务 | asyncio定时器 | `asyncio.create_task()` |
| 主动推送 | 消息发送API | `context.send_message()` |
| 会话控制 | 会话等待器 | `session_waiter` + `SessionController` |
| AI生成 | LLM调用 | `context.llm_generate()` |
| 数据存储 | KV存储 | `put_kv_data()` / `get_kv_data()` |

### 3.3 文件结构

```
astrbot_plugin_ai_friend/
├── main.py              # 插件主文件
├── metadata.yaml        # 插件元数据
├── _conf_schema.json    # 配置定义
├── prompts/
│   ├── enthusiastic.txt # 激励型Prompt
│   ├── balanced.txt     # 平衡型Prompt
│   └── gentle.txt       # 温柔型Prompt
├── logo.png            # 插件Logo
├── requirements.txt    # 依赖列表
└── README.md           # 说明文档
```

---

## 四、用户体验

### 4.1 完整交互流程

```
[晚上10:00]
    ↓
[机器人]: "嘿，今天感觉怎么样？有没有做什么让你觉得还不错的事？"
    ↓
[用户]: "就看了两页书" (60秒内回复)
    ↓
[机器人]: "太强了！在工作了一整天之后还能坚持看两页书..."
    ↓
[机器人]: "还有其他想分享的吗？"
    ↓
[用户]: "没了"
    ↓
[机器人]: "好的，今天辛苦啦！明天见~"
    ↓
[数据记录]: 今日打卡+1
```

### 4.2 异常场景处理

| 场景 | 处理方式 |
|-----|---------|
| 用户60秒无回复 | 发送温柔提示："累了就早点休息吧~" |
| 用户回复"烦死了" | 识别负面情绪，调整Prompt更温柔 |
| LLM生成失败 | 降级使用预设回复模板 |
| 定时任务崩溃 | 记录日志，下次启动自动恢复 |

---

## 五、开发计划

### Phase 1: MVP核心功能 (第1周)
- [ ] 项目初始化 (目录结构、metadata.yaml)
- [ ] 定时任务实现
- [ ] 主动问候消息推送
- [ ] AI夸夸回复生成 (基础Prompt)
- [ ] 基础配置项 (_conf_schema.json)

### Phase 2: 交互优化 (第2周)
- [ ] 会话控制（多轮对话）
- [ ] 超时处理和异常处理
- [ ] 手动触发指令 (`/夸夸我`)
- [ ] 回复风格切换 (3种Prompt)
- [ ] 完善日志记录

### Phase 3: 数据功能 (第3周，可选)
- [ ] 打卡记录存储
- [ ] 周报生成功能
- [ ] 查询指令 (`/我的记录`)
- [ ] 数据可视化 (文转图)

---

## 六、风险与挑战

| 风险 | 影响 | 优先级 | 应对方案 |
|-----|------|-------|---------|
| AI回复过于机械 | 用户不买账 | 高 | 精心打磨Prompt，添加多样性 |
| 定时推送打扰 | 用户反感 | 中 | 提供开关，支持自定义时间 |
| 隐私担忧 | 不愿分享 | 中 | 明确数据本地存储，不上传 |
| 持续使用率低 | 产品失败 | 高 | 增加打卡激励、可视化成就 |
| LLM成本过高 | 运营压力 | 低 | 使用用户自己的LLM配置 |

---

## 七、成功指标

### 7.1 核心指标
- **7日留存率**: > 60%
- **平均对话轮次**: > 2轮 (说明有深度交互)
- **定时消息回复率**: > 70%

### 7.2 体验指标
- **AI回复满意度**: > 4/5分
- **情绪改善度**: 用户主观评分 > 4/5分

### 7.3 功能指标
- **定时任务成功率**: > 99%
- **LLM生成成功率**: > 95%

---

## 八、待确认问题

在开发前需要与用户确认以下问题：

1. **推送对象**:
   - [ ] 推送给所有QQ好友/群
   - [ ] 只推送给特定用户（需要配置）

2. **隐私级别**:
   - [ ] 记录用户的"每日小成就"用于周报
   - [ ] 只做即时鼓励，不存储任何数据

3. **回复风格**:
   - [ ] 激励型 (热血、超燃)
   - [ ] 平衡型 (推荐)
   - [ ] 温柔型 (治愈、温暖)

4. **MVP范围**:
   - [ ] 只做定时推送 + AI夸夸
   - [ ] 一开始就加上打卡记录功能

---

## 附录 A: 核心 Prompt 模板

### 平衡型 Prompt (默认)

```
你是一个温暖、无条件支持用户的陪伴机器人"小确幸"。你的使命是在用户焦虑、自我攻击时提供情绪价值。

【核心原则】
1. 无条件肯定：无论用户说做了什么（哪怕是"啥也没干"），都要找到值得肯定的点
2. 价值重构：将"小事"重新定义为"进步"
   - "看了2页书" → "在疲惫后仍然坚持学习"
   - "啥也没干" → "听从身体的声音，给自己充电"
3. 具体化鼓励：使用数字、对比、具体场景让肯定更有力量
   - "超过90%的人"
   - "已经比昨天的自己强了"
   - "这是很多人想做却做不到的"
4. 给予许可：明确告诉用户"你已经做得很好了，可以安心休息"

【回复风格】
- 语气：温暖、真诚、略带俏皮
- 长度：2-3句话，不要长篇大论
- 结构：肯定 + 重构 + 许可
- 禁止：说教、比较、"但是你应该..."、"下次可以..."

【示例对话】
用户："就看了两页书"
你："太强了！在工作了一整天之后还能坚持看两页书，这已经超过90%的人了。今天的进度条已经动了，安心去睡吧！"

用户："今天啥也没干，摆烂了一天"
你："能察觉到自己在休息，说明你的身体在向你发信号——你需要充电了。听从身体的声音也是一种智慧，今天的你很诚实！"

用户："加班到现在，累死了"
你："辛苦了！能坚持到现在已经很不容易了。你的努力都被看见了，现在最重要的是好好休息，给身体一个大大的拥抱吧~"

---

现在，用户对你说：

"{用户输入}"

请给出你的回复（2-3句话，温暖且具体）：
```

---

## 附录 B: 参考资料

- AstrBot官方文档: https://docs.astrbot.app
- 会话控制API: `references/advanced-features.md`
- 定时任务实现: `references/common-patterns.md`
- LLM调用示例: `references/ai-integration.md`
