# 开发任务清单

> 更新时间: 2026-01-12

## 当前状态: 设计阶段 ✅

---

## Phase 1: MVP核心功能 (预计第1周)

### 1.1 项目初始化
- [ ] 创建插件目录结构
  - [ ] `main.py` - 插件主文件
  - [ ] `metadata.yaml` - 插件元数据
  - [ ] `_conf_schema.json` - 配置定义
  - [ ] `requirements.txt` - 依赖列表
  - [ ] `prompts/` - Prompt模板目录
- [ ] 编写基础插件类框架
  - [ ] 注册插件装饰器
  - [ ] `__init__` 方法（读取配置）
- [ ] 设计 Logo (可选)

### 1.2 定时任务实现
- [ ] 实现每日定时触发逻辑
  - [ ] 解析配置的时间字符串 (HH:MM)
  - [ ] 计算下次触发的时间间隔
  - [ ] 使用 `asyncio.create_task()` 创建后台任务
- [ ] 处理时区问题（系统本地时间）
- [ ] 测试：手动触发定时任务

### 1.3 主动推送消息
- [ ] 实现消息推送逻辑
  - [ ] 获取目标用户列表（从配置读取）
  - [ ] 构建问候消息链
  - [ ] 调用 `context.send_message()` 推送
- [ ] 处理推送失败的异常
- [ ] 添加日志记录（推送成功/失败）
- [ ] 测试：向单个用户推送消息

### 1.4 AI夸夸回复生成
- [ ] 编写核心 Prompt 模板
  - [ ] 平衡型 Prompt (`prompts/balanced.txt`)
  - [ ] 激励型 Prompt (`prompts/enthusiastic.txt`)
  - [ ] 温柔型 Prompt (`prompts/gentle.txt`)
- [ ] 实现 LLM 调用逻辑
  - [ ] 获取当前聊天的 provider_id
  - [ ] 调用 `context.llm_generate()`
  - [ ] 处理生成失败的降级方案（预设回复）
- [ ] 根据配置选择不同风格的 Prompt
- [ ] 测试：输入不同类型的用户回复，验证AI回复质量

### 1.5 多轮对话支持
- [ ] 实现会话等待逻辑
  - [ ] 使用 `session_waiter` 装饰器
  - [ ] 使用 `SessionController` 控制对话流程
  - [ ] 设置 60 秒超时
- [ ] 实现对话轮数控制（最多3轮）
- [ ] 超时处理：发送温柔提示
- [ ] 用户主动结束对话的识别（"没了"、"谢谢"等）
- [ ] 测试：多轮对话流程

### 1.6 配置系统
- [ ] 创建 `_conf_schema.json`
  - [ ] scheduled_time: 推送时间
  - [ ] reply_style: 回复风格
  - [ ] enable_scheduled_push: 启用开关
  - [ ] target_users: 目标用户列表
  - [ ] max_conversation_rounds: 最大对话轮数
- [ ] 在插件中读取和使用配置
- [ ] 配置变更时的处理逻辑
- [ ] 测试：修改配置后验证生效

### 1.7 错误处理和日志
- [ ] 添加全局异常捕获
- [ ] 记录关键操作的日志
  - [ ] 定时任务触发
  - [ ] 消息推送成功/失败
  - [ ] LLM 调用成功/失败
  - [ ] 会话开始/结束
- [ ] 用户友好的错误提示
- [ ] 测试：模拟各种异常场景

---

## Phase 2: 交互优化 (预计第2周)

### 2.1 手动触发指令
- [ ] 实现 `/夸夸我` 指令
  - [ ] 使用 `@filter.command()` 装饰器
  - [ ] 触发同样的夸夸对话流程
- [ ] 实现 `/今日总结` 指令（别名）
- [ ] 测试：手动触发指令流程

### 2.2 回复风格切换
- [ ] 完善三种 Prompt 模板
  - [ ] 测试激励型风格的效果
  - [ ] 测试温柔型风格的效果
  - [ ] 根据测试结果优化 Prompt
- [ ] 根据配置动态加载 Prompt
- [ ] 测试：切换不同风格验证差异

### 2.3 异常场景处理
- [ ] 用户无回复超时处理
- [ ] 用户回复负面情绪的识别和处理
- [ ] LLM 生成失败的降级方案
- [ ] 定时任务崩溃后的自动恢复
- [ ] 测试：各种异常场景

### 2.4 性能优化
- [ ] 减少不必要的日志输出
- [ ] 优化 LLM 调用的超时设置
- [ ] 异步处理耗时操作
- [ ] 测试：并发场景下的稳定性

---

## Phase 3: 数据功能 (可选，预计第3周)

### 3.1 打卡记录
- [ ] 设计数据结构（用户->日期->内容）
- [ ] 实现打卡数据存储
  - [ ] 使用 `put_kv_data()` 存储
  - [ ] 使用 `get_kv_data()` 读取
- [ ] 在对话结束时保存打卡记录
- [ ] 测试：多用户打卡数据隔离

### 3.2 周报生成
- [ ] 实现周报定时任务（每周日晚上）
- [ ] 统计本周打卡天数
- [ ] 生成周报内容（回顾每天的记录）
- [ ] 推送周报消息
- [ ] 测试：周报内容的准确性

### 3.3 查询指令
- [ ] 实现 `/我的记录` 指令
  - [ ] 查询本周打卡记录
  - [ ] 查询本月打卡记录
- [ ] 数据可视化（可选）
  - [ ] 使用文转图生成打卡日历
- [ ] 测试：查询不同时间段的记录

---

## Phase 4: 发布准备

### 4.1 文档完善
- [ ] 编写详细的 README.md
- [ ] 编写使用指南
- [ ] 添加配置说明
- [ ] 添加常见问题 FAQ

### 4.2 测试和优化
- [ ] 完整流程测试
- [ ] 多用户并发测试
- [ ] 长期运行稳定性测试
- [ ] 根据测试结果优化代码

### 4.3 发布
- [ ] 推送代码到 GitHub
- [ ] 制作插件 Logo
- [ ] 提交到 AstrBot 插件市场
- [ ] 编写发布公告

---

## 待确认问题 ❓

在开始开发前需要确认：

1. **推送对象**:
   - [ ] 推送给所有QQ好友/群
   - [x] 只推送给特定用户（需要配置）
   - **决定**: 默认不推送，用户需要通过私聊发送指令开启推送（订阅机制）

2. **隐私级别**:
   - [x] 记录用户的"每日小成就"用于周报
   - [ ] 只做即时鼓励，不存储任何数据
   - **决定**: 可以记录数据，为后续周报功能做准备

3. **回复风格**:
   - [ ] 激励型 (热血、超燃)
   - [x] 平衡型 (推荐)
   - [ ] 温柔型 (治愈、温暖)
   - **决定**: 默认平衡型，用户可在配置中切换

4. **MVP范围**:
   - [x] 只做定时推送 + AI夸夸
   - [ ] 一开始就加上打卡记录功能
   - **决定**: MVP 先实现定时推送 + AI夸夸，打卡记录功能后续迭代

---

## 进度追踪

| 阶段 | 状态 | 完成度 | 预计完成时间 |
|------|------|--------|-------------|
| Phase 1: MVP核心 | 待开始 | 0% | 第1周 |
| Phase 2: 交互优化 | 未开始 | 0% | 第2周 |
| Phase 3: 数据功能 | 未开始 | 0% | 第3周 |
| Phase 4: 发布准备 | 未开始 | 0% | 第4周 |

---

## 备注

- 每完成一个任务，在前面打 `[x]` 标记
- 遇到问题在下方"问题记录"区域记录
- 重要决策在"决策记录"区域记录

## 问题记录

暂无

## 决策记录

### 2026-01-12: 核心需求确认
1. **订阅机制**: 采用订阅机制，用户通过指令 `/开启陪伴` 来订阅定时推送，避免默认打扰
2. **数据存储**: 允许记录用户的打卡数据，为后续周报功能做准备（Phase 3）
3. **默认风格**: 默认使用平衡型回复风格，用户可在配置中切换
4. **MVP范围**: 先实现核心功能（订阅管理 + 定时推送 + AI夸夸 + 多轮对话），打卡记录放到 Phase 3
